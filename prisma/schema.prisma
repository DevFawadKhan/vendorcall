// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output = "../src/app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  // url  = env("DATABASE_URL")
}

// Enums
enum UserType {
  customer
  provider
  admin
}

enum Gender {
  male
  female
  other
  prefer_not_to_say
}

enum DocumentType {
  license
  certification
  insurance
  id_proof
  other
}

enum BookingStatus {
  pending
  confirmed
  assigned
  dispatched
  in_progress
  completed
  cancelled
  refunded
}

enum PaymentStatus {
  pending
  paid
  failed
  refunded
}

enum PaymentMethod {
  credit_card
  debit_card
  paypal
  apple_pay
  google_pay
  cash
}

enum VerificationStatus {
  pending
  verified
  rejected
}

enum AddressType {
  home
  work
  other
}

// Models

model User {
  // id              String           @id @default(uuid())
  id                 Int           @id @default(autoincrement())
  email           String           @unique
  phone           String?
  passwordHash    String           @map("password_hash")
  firstName       String?          @map("first_name")
  lastName        String?          @map("last_name")
  userType        UserType         @map("user_type")
  avatarUrl       String?          @map("avatar_url")
  isVerified      Boolean          @default(false) @map("is_verified")
  isActive        Boolean          @default(true) @map("is_active")
  lastLogin       DateTime?        @map("last_login")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  metadata        Json?            @default("{}")

  // Relations
  profile        UserProfile?
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens     PasswordResetToken[]
  // provider       ServiceProvider?
  // addresses      UserAddress[]
  // bookings       Booking[]
  // payments       Payment[]
  // reviews        Review[]
  // notifications  Notification[]
  // paymentMethods CustomerPaymentMethod[]

  @@map("users")
}

model UserProfile {
  id                      String    @id @default(uuid()) @map("profile_id")
  userId                  Int    @unique @map("user_id")
  dateOfBirth            DateTime?  @map("date_of_birth")
  gender                 Gender?
  bio                    String?
  languages              String[]
  notificationPreferences Json      @default("{\"email\": true, \"sms\": true, \"push\": true, \"marketing\": false}")
  createdAt              DateTime   @default(now()) @map("created_at")
  updatedAt              DateTime   @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("userprofiles")
}
// Password Reset Tokens
model PasswordResetToken {
  // id        String   @id @default(uuid())
    id          Int    @id @default(autoincrement())
  userId    Int      @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  otp       String   // Only OTP, no token
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  
  @@unique([userId, otp])  // Composite unique constraint
  @@index([userId])
  @@index([otp])
  @@map("password_reset_tokens")
}

// Email Verification Tokens
model EmailVerificationToken {
  // id        String   @id @default(uuid())
  id         Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  otp       String   
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  
  @@unique([userId, otp])  // Composite unique constraint
  @@index([userId])
  @@index([otp])
  @@map("email_verification_tokens")
}

// Service Categories and Services Models
model ServiceCategory {
  id               Int              @id @default(autoincrement()) @map("category_id")
  name             String           @db.VarChar(100)
  slug             String           @unique @db.VarChar(100)
  description      String?
  iconUrl          String?          @map("icon_url")
  
  // Self-referential relationship for parent category
  parentCategoryId Int?             @map("parent_category_id")
  parentCategory   ServiceCategory? @relation("CategoryParent", fields: [parentCategoryId], references: [id])
  subCategories    ServiceCategory[] @relation("CategoryParent")
  
  sortOrder        Int              @default(0) @map("sort_order")
  isActive         Boolean          @default(true) @map("is_active")
  createdAt        DateTime         @default(now()) @map("created_at")
  
  // Relationship to services
  services         Service[]
  
  @@map("service_categories")
}

model Service {
  id               Int                 @id @default(autoincrement()) @map("service_id")
  categoryId       Int                 @map("category_id")
  name             String              @db.VarChar(200)
  slug             String              @unique @db.VarChar(200)
  description      String?
  basePrice        Decimal             @map("base_price") @db.Decimal(10, 2)
  durationMinutes  Int?                @map("duration_minutes")
  imageUrls        String[]            @map("image_urls")
  requirements     String?
  isPopular        Boolean             @default(false) @map("is_popular")
  isActive         Boolean             @default(true) @map("is_active")
  sortOrder        Int                 @default(0) @map("sort_order")
  createdAt        DateTime            @default(now()) @map("created_at")
  updatedAt        DateTime            @updatedAt @map("updated_at")
  
  // Relationships
  category         ServiceCategory     @relation(fields: [categoryId], references: [id])
  pricingTiers     ServicePricingTier[]
  
  @@map("services")
}

model ServicePricingTier {
  id               Int        @id @default(autoincrement()) @map("tier_id")
  serviceId        Int        @map("service_id")
  tierName         String     @map("tier_name") @db.VarChar(100)
  description      String?
  price            Decimal    @db.Decimal(10, 2)
  durationMinutes  Int        @map("duration_minutes")
  includes         String[]   @map("includes")
  sortOrder        Int        @default(0) @map("sort_order")
  createdAt        DateTime   @default(now()) @map("created_at")
  
  // Relationship
  service          Service    @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  @@map("service_pricing_tiers")
}